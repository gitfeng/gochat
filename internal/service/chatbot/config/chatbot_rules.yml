# config/chatbot_rules.yaml
# just for unittest run

# 1. åŸºç¡€é…ç½®
metadata:
  bot_name: "æ™ºèƒ½åŠ©æ‰‹"
  version: "2.1.0"
  default_lang: "zh-CN"

# 2. æ„å›¾è¯†åˆ«è§„åˆ™
intent_detection:
  regex_patterns:
    - intent: "greeting"
      patterns: 
        - "ä½ å¥½|å—¨|hello"
        - "æ—©ä¸Šå¥½|ä¸‹åˆå¥½|æ™šä¸Šå¥½"
      priority: 1

    - intent: "weather_query"
      patterns:
        - ".*(å¤©æ°”|æ°”æ¸©|ä¸‹é›¨).*"
      required_slots: ["city", "date"]
  
  ml_model: 
    path: "models/intent_classifier_v3.h5"
    threshold: 0.75

# 3. å¯¹è¯æµç¨‹çŠ¶æ€æœº
dialogue_flow:
  states:
    - name: "welcome"
      transitions:
        - intent: "greeting"
          next_state: "main_menu"
          actions:
            - type: "response"
              content: "æ‚¨å¥½ï¼Œæˆ‘æ˜¯${bot_name}ï¼Œè¯·é—®éœ€è¦ä»€ä¹ˆå¸®åŠ©ï¼Ÿ"
            - type: "set_context"
              key: "conversation_start_time"
              value: "${timestamp}"

    - name: "weather_query"
      entry_actions:
        - type: "call_api"
          endpoint: "https://api.weather.com/v3"
          params:
            city: "${slot:city}"
            date: "${slot:date}"
          result_key: "weather_data"
      
      responses:
        - condition: "${weather_data.temp > 30}"
          template: |
            ${city}${date}å¤©æ°”ç‚çƒ­ï¼Œæœ€é«˜æ°”æ¸©${temp}â„ƒï¼Œ
            è®°å¾—åšå¥½é˜²æ™’å“¦ï¼ğŸŒ
        
        - default: true
          template: "${city}${date}æ°”æ¸©${temp}â„ƒï¼Œ${description}"

# 4. ä¸Šä¸‹æ–‡ç®¡ç†
context_management:
  slot_filling:
    - slot: "city"
      prompts:
        - "è¯·é—®æ‚¨è¦æŸ¥è¯¢å“ªä¸ªåŸå¸‚ï¼Ÿ"
        - "éœ€è¦äº†è§£å“ªä¸ªåŸå¸‚çš„å¤©æ°”å‘¢ï¼Ÿ"
      validation:
        type: "regex"
        pattern: "^[\u4e00-\u9fa5]{2,4}å¸‚?$"
        error_msg: "è¯·è¾“å…¥æœ‰æ•ˆåŸå¸‚åç§°ï¼Œå¦‚ï¼šåŒ—äº¬ã€ä¸Šæµ·å¸‚"

  context_timeout: 300  # å•ä½ï¼šç§’

# 5. å¤šæ¨¡æ€å“åº”
response_templates:
  text:
    farewell: 
      - "æ„Ÿè°¢ä½¿ç”¨ï¼Œå†è§ï¼ğŸ‘‹"
      - "æœ‰ä»»ä½•é—®é¢˜éšæ—¶æ‰¾æˆ‘å“¦~"

  rich_content:
    - type: "quick_reply"
      buttons:
        - title: "æŸ¥çœ‹å¤©æ°”"
          payload: "WEATHER_QUERY"
        - title: "è”ç³»å®¢æœ"
          payload: "HUMAN_HELP"

    - type: "carousel"
      items: 
        - title: "æ“ä½œæŒ‡å—"
          image: "https://example.com/guide.jpg"
          buttons: [...]
  
# 6. å¼‚å¸¸å¤„ç†
error_handling:
  default_fallback: "æŠ±æ­‰ï¼Œæˆ‘è¿˜åœ¨å­¦ä¹ ä¸­ï¼Œæš‚æ—¶æ— æ³•å›ç­”è¿™ä¸ªé—®é¢˜"
  escalation_rules:
    - condition: "${error.code == 503}"
      action: "redirect_to_human"
  
  retry_policy:
    max_attempts: 2
    backoff: 1000  # æ¯«ç§’

# 7. ä¸ªæ€§åŒ–é…ç½®
personalization:
  user_segments:
    - name: "vip_users"
      condition: "${user.level >= 3}"
      response_modifier: 
        prefix: "å°Šè´µçš„VIPç”¨æˆ·ï¼Œ"

  time_based_rules:
    - time_range: "00:00-06:00"
      response_suffix: "ï¼ˆå¤œé—´æœåŠ¡æ¨¡å¼ï¼‰"

# 8. å­¦ä¹ æœºåˆ¶
learning:
  feedback_loop:
    negative_triggers:
      - user_sentiment: "negative"
      - explicit_feedback: "dislike"
    
    action: "flag_for_review"

# æ”¯æŒ A/B æµ‹è¯•
experimental:
  variant_groups:
    - name: "welcome_message"
      variants:
        - weight: 50%
          content: "æ–°ç‰ˆæœ¬é—®å€™è¯­1"
        - weight: 50% 
          content: "ä¼ ç»Ÿé—®å€™è¯­"


